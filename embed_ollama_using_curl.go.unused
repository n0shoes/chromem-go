package chromem

//	"errors"
import (
	"context"
	"encoding/json"
	"fmt"
	"os/exec"
	"strings"
	"sync"
	"time"
)

const defaultBaseURLOllama = "http://localhost:11434/api"

type ollamaResponse struct {
	Embeddings [][]float32 `json:"embeddings"`
}

// NewEmbeddingFuncOllama returns a function that creates embeddings for a text
// using Ollama's embedding API. You can pass any model that Ollama supports and
// that supports embeddings. A good one as of 2024-03-02 is "nomic-embed-text".
// See https://ollama.com/library/nomic-embed-text
// baseURLOllama is the base URL of the Ollama API. If it's empty,
// "http://localhost:11434/api" is used.
func NewEmbeddingFuncOllama(model string, baseURLOllama string) EmbeddingFunc {
	if baseURLOllama == "" {
		baseURLOllama = defaultBaseURLOllama
	}

	var checkedNormalized bool
	checkNormalized := sync.Once{}

	return func(ctx context.Context, text string) ([]float32, error) {
		maxRetries := 3
		var lastErr error

		for attempt := 0; attempt < maxRetries; attempt++ {
			if attempt > 0 {
				// Exponential backoff: 500ms, 1s, 1.5s
				backoff := time.Duration(attempt) * 500 * time.Millisecond
				fmt.Printf("[RETRY] Attempt %d/%d after %v delay\n", attempt+1, maxRetries, backoff)
				time.Sleep(backoff)
			}

			// Prepare the request body
			reqBody, err := json.Marshal(map[string]string{
				"model": model,
				"input": text,
			})
			if err != nil {
				return nil, fmt.Errorf("couldn't marshal request body: %w", err)
			}

			url := baseURLOllama + "/embed"
			if attempt == 0 {
				fmt.Printf("[DEBUG] Ollama embedding request via curl - URL: %s, text length: %d bytes\n", url, len(text))
			}

			// Use curl instead of Go HTTP client - it's proven reliable with Ollama
			cmd := exec.CommandContext(ctx, "curl", "-s", "-X", "POST", url,
				"-H", "Content-Type: application/json",
				"-d", string(reqBody))

			output, err := cmd.CombinedOutput()
			if err != nil {
				lastErr = fmt.Errorf("curl command failed: %w, output: %s", err, string(output))
				continue // Retry
			}

			if attempt == 0 {
				fmt.Printf("[DEBUG] Ollama response via curl - body length: %d bytes\n", len(output))
			}

			// Parse JSON response
			var embeddingResponse ollamaResponse
			outputStr := strings.TrimSpace(string(output))
			err = json.Unmarshal([]byte(outputStr), &embeddingResponse)
			if err != nil {
				lastErr = fmt.Errorf("couldn't unmarshal response: %w, response: %s", err, outputStr)
				continue // Retry
			}

			// Check if the response contains embeddings
			if len(embeddingResponse.Embeddings) == 0 || len(embeddingResponse.Embeddings[0]) == 0 {
				lastErr = fmt.Errorf("no embeddings found in response, body: %s", outputStr)
				continue // Retry
			}

			// Success! Process the embedding
			v := embeddingResponse.Embeddings[0]
			checkNormalized.Do(func() {
				if isNormalized(v) {
					checkedNormalized = true
				} else {
					checkedNormalized = false
				}
			})
			if !checkedNormalized {
				v = normalizeVector(v)
			}

			return v, nil
		}

		// All retries failed
		return nil, fmt.Errorf("failed after %d attempts: %w", maxRetries, lastErr)
	}
}
